---
title: MSVC与MinGW
date: 2025-02-10 09:56:28
tags:
- C++
- MSVC
- MinGW
categories:
- 学习笔记
- 编程语言
---
# MSVC与MinGW
## 1. 简介
在Windows上编译C/C++通常会用到两种工具链
MinGW (Minimalist GNU for Windows)和MSVC (Microsoft Visual C++)

## 2. 区别
### 2.1 编译器
1. MinGW 使用GNU编译器集合（GCC）的变体，它是一个开源的编译器工具链，支持多种编程语言。MinGW 的编译器通常被称为 GCC 或 G++。
2. MSVC 使用 Microsoft 的专有编译器，该编译器是 Visual Studio 集成开发环境（IDE）或 Visual Studio 生成工具的一部分，通常称为 cl.exe。

### 2.2 标准库
1. MinGW 通常使用 GNU 的标准 C 库（glibc）或 MinGW-w64 中的 C 运行时库。它还可以使用 MinGW 专用的头文件和库，以便在 Windows 上开发。
2. MSVC 使用 Microsoft 的 C 运行时库（CRT），这意味着它具有与 Windows API 更好的集成，但在一些情况下可能不够跨平台。

### 2.3 开发环境
1. MinGW 通常以类 Unix 的方式工作，可以使用命令行或与其他开发工具集成
2. MSVC 通常与 Visual Studio IDE (提供了一种集成的开发环境，具有丰富的图形用户界面和调试工具) 或 Visual Studio 生成工具 一起使用。

### 2.4 库依赖
1. 库文件格式：
    MinGW 使用的是 GNU 工具链，因此它通常使用与 GNU 标准库兼容的库文件格式。这些库文件具有以  .a  为扩展名的静态库和以 .dll 为扩展名的动态链接库。
    MSVC 使用 Microsoft 的 C/C++ 标准库格式，这些库文件通常以  .lib 为扩展名，但也可以包含 .dll 动态链接库文件。

2. 库的兼容性：
    MinGW 生成的库文件通常与 MSVC 生成的库文件不兼容。这意味着你不能将 MinGW 生成的对象文件与 MSVC 生成的库文件链接，反之亦然。
    如果你使用 MinGW 编译你的应用程序，你需要确保你使用的库是专门为 MinGW 编译的，或者在构建库时采用兼容的编译选项。
    同样，如果你使用 MSVC 编译，你需要使用与 MSVC 兼容的库文件。

3. 第三方库支持：
    一些第三方库可能会提供适用于 MinGW 和 MSVC 的不同版本。在选择库时，你需要确保选择与你的编译器兼容的版本。
    有些库可能提供了 CMake 或其他构建工具的支持，这些工具可以帮助你在不同的编译器下进行构建。

## 3. 运行时库
### 3.1 简介
运行时库(RunTime Library)是一组标准化的软件函数集合, 是程序运行时用于支持程序运行所需的一些函数和数据的库。

### 3.2 运行时库链接方式
运行时库链接方式有两种：
1. 静态链接：
    静态链接是指在编译时将运行时库的代码直接嵌入到可执行文件中。这样做目标工程的编译产物更大，因为它包含了所有的运行时库代码。但是它不依赖外部的库文件, 提高了应用的独立性, 并且便于部署.
2. 动态链接：
    动态链接是指在编译时不将运行时库(通常是动态链接库DLL或共享对象SO)的代码直接嵌入到可执行文件中，而是在程序运行时才加载运行时库。这样做的好处是多个程序可以共享相同的运行时库，从而减少内存占用。动态链接的目标工程的编译产物更小，因为它只包含了可执行文件的代码和数据，而不包含运行时库的代码, 实现对库文件的共享使用, 节省系统资源。

### 3.3 链接方式的选择
1. 部署简易性: 如果需要简化部署过程, 不希望处理外部的运行时库依赖, 则可以选择静态链接方式;
2. 体积和资源占用: 如果对可执行文件的体积和内存占用有严格要求, 动态链接可以减少重复的库代码占用;
3. 更新与维护: 动态链接便于库文件的更新和维护, 特别是当涉及到安全更新和修复时;
4. 兼容性: 动态链接兼容性可能更好, 因为它保证了与系统的兼容性和一致性;
5. 特殊需求: 对于需要插件或按需加载功能的应用, 运行时动态链接或延迟加载等技术更合适.

### 3.4 MSVC实战
MSVC的编译选项MT、MD、MTd、MDd指定了程序是静态链接还是动态链接, 以及是否是调试版本的库.
- MT： mutithread  Static，多线程库，编译器会从运行时库里面选择多线程静态连接库来解释程序中的代码，即连接LIBCMT.lib库
- MTd：mutithread debug Static ，多线程调试版，连接LIBMITD.lib库
- MD：mutithread  +Dynamic，多线程动态库，连接MSVCRT.lib库，这是个导入库，对应动态库为MSVCRT.dll
- MDd： mutithread +Dynamic+debug，多线程动态调试库，连接MSVCRTD.lib库，对应动态库为MSVCRTD.dll

MT: Multi-Threaded和MD: Multi-Threaded DLL。
早期的 Microsoft Visual C++ 版本中，存在单线程版本的运行时库，这些运行时库不支持多线程程序，从 Visual Studio 2005 开始，所有的运行时库都是多线程的（MT 或 MD），单线程的运行时库已经被淘汰。

**优缺点**
- MT/MTd（静态链接）的优点是不需要在部署时包含额外的运行时库DLL文件，因为所有的运行时代码都已经包含在最终的可执行文件中。这简化了部署过程并减少了对环境的依赖。缺点是最终的可执行文件会比较大（因为把运行时库二进制也带进来了），如果项目中多个库使用了静态链接运行时库，也会出现重复的、冗余的代码占用内存。
- MD/MDd（动态链接）的优点是可执行文件体积较小，多个程序可以共享同一份运行时库的副本，节省资源。缺点是在部署程序时需要确保正确版本的运行时库DLL文件也被安装在目标系统上，否则程序无法运行。

### 3.5 常见问题
1. 如果使用动态链接，但是没有打包运行时库会怎样？
    许多开发者都可能遇到忘记打包运行时库的场景，表现上是在自己电脑上正常运行，但是发布到其他电脑上提示找不到xxx.dll，
    {% asset_img "not_found_runtime140_1.png" "not_found_runtime140_1.dll" %}
    网上也提供了很多接近方案，例如VC Runtime 集合，包含了各种版本的 Visual C++ 运行时库的集合。如果一个应用程序是使用特定版本的 Visual Studio 编译的，并且使用了动态链接库（DLL），那么它就需要相应版本的 VC Runtime 来确保正确运行。

    VC Runtime 集合的出现主要是为了解决以下问题：
    - 版本兼容：不同的应用程序可能需要不同版本的 VC Runtime。一个集合包含了多个版本的运行时库，可以确保大多数应用程序的兼容性。
    - 简化安装：用户可以一次性安装多个版本的 VC Runtime，而不需要单独下载和安装每个应用程序需要的特定版本。
    - 解决缺失：如果用户遇到因为缺少 VC Runtime 导致的问题，安装集合包可以快速解决缺失的库文件问题。
    从某种角度上来说，VC Runtime 集合的存在并不直接代表软件开发者没有正确打包动态运行时库，而是因为操作系统或软件的多样性和复杂性，使得拥有一个集合包来解决潜在的兼容性问题变得更加方便和必要。不过，为了减少不必要的用户反馈，最佳实践仍然是我们在软件分发时包括所有必要的依赖，确保自己的软件不出现运行时库的缺少的问题。

